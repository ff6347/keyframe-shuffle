// Copyright (c)  2012 // Fabian "fabiantheblind" Morón Zirfas  // Permission is hereby granted, free of charge, to any // person obtaining a copy of this software and associated// documentation files (the "Software"), to deal in the Software// without restriction, including without limitation the rights // to use, copy, modify, merge, publish, distribute, sublicense,// and/or sell copies of the Software, and to  permit persons to // whom the Software is furnished to do so, subject to // the following conditions:  // The above copyright notice and this permission notice// shall be included in all copies or substantial portions of the Software.  // THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND,// EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES// OF MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.// IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM,// DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION OF  CONTRACT,// TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTIO// WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.  // see also http://www.opensource.org/licenses/mit-license.php{var meta = new Object();meta.settings = {    /*      0 = per layer    1 = per prop    2 per key     */    shufflescope : 2,    /*    0 = both    1= pos    2 = neg    */    keytimedir : 0,    range: 0};/** * Will hold all strings used in the user interface * @type {Object} */meta.uiStrings = {    scriptName : "keyframe-shuffle"};meta.errorStrings = {    noComp:"Please select a composition.",    noBuzzgenFile : "The 'buzz-gen.json' file is missing. Go to " +     website + " and download the latest version of "+ meta.uiStrings.scriptName};run_scipt(this);function run_scipt(thisObj){/** * First we have to do some legal stuff * go to the end of the script to se the dialog * */// var res = null;// var settingsSectionName = "swissd";// if((app.settings.haveSetting(settingsSectionName,"licaccept") == true)){// var licres = parseInt(app.settings.getSetting(settingsSectionName,"licaccept"));// if (licres==1){//     res = [true,true];// } else {//     res = licenseDiag("swissd","http://fabiantheblind.info");//     };// }else{//   res = licenseDiag("swissd","http://fabiantheblind.info");// };// if (!res[1]){//     return;// }if(res[0]){//     app.settings.saveSetting(settingsSectionName,"licaccept",1);// };///   THIS WILL CHECK IF PANEL IS DOCKABLE OR FLAOTING WINDOW     var win   = buildUI(thisObj);   if ((win != null) && (win instanceof Window)) {      win.center();      win.show();      }; // end if win  null and not a instance of window };function buildUI(thisObj) {var win = (thisObj instanceof Panel)  ? thisObj : new Window('palette', 'Script Window',[0,57,140,179],{resizeable: true}); if (win != null) { var H = 20;var W = 120;var G = 3;var x = G;var y = G;// var itemw1 = 50;win.stxt_off = win.add('statictext', [x,y,W/2,H], 'offset:'); win.stxt_off.justify = 'left';x = x + (W/2) + G;win.etxt_off = win.add('edittext', [x,y,W,H], '0.5'); win.etxt_off.justify = 'left'; x = G;y = y + H + G;win.radiogrp = win.add('panel',[x,y,W,y + ((H * 3.66) + (G * 2))],'',{borderStyle: 'none'});xp = G;yp = G;win.radio_one = win.radiogrp.add('radiobutton',[xp,yp,W,H], 'forward');yp = yp + H + G;win.radio_two = win.radiogrp.add('radiobutton',[xp,yp,W, yp +H], 'backward');yp = yp + H + G;win.radio_three = win.radiogrp.add('radiobutton',[xp,yp,W,yp +H], 'both');win.radio_one.value = false;x = G;y = y + ((H * 4) + (G * 2));win.button_run = win.add('button', [x,y,W,y + H], 'shuffle');win.button_run.onClick = function () {    shuffle_keys(meta);}; } return win };// shuffle_keys (meta);function shuffle_keys(meta){    app.beginUndoGroup("shuffle keys");meta.settings.range = parseFloat(prompt("Enter a range in seconds to shuffle", "0.5",""));var curComp = app.project.activeItem;   if (!curComp || !(curComp instanceof CompItem)){        alert(meta.errorStrings.noComp);        return;    };//~ var fdur  = curComp.frameDuration;//~ var shuffle = shuffle_val / fdur;var selLayers =  curComp.selectedLayers;// var shuffle = Math.random() -1; // by half second before and after    var data = new Array();for (var i = 0; i < selLayers.length;i++){        var lyr = selLayers[i];        // theLayers.push(lyr);        var props = new Array();        for(var j = 0; j < lyr.selectedProperties.length; j++){             var prop = lyr.selectedProperties[j];            // layer_sel_props.push(prop);            var propkeys = new Array();            // var keys;            //             for (var k = 0; k < prop.selectedKeys.length;k++){                var keyTime = prop.keyTime(prop.selectedKeys[k]);                var keyValue = prop.keyValue(prop.selectedKeys[k]);                var keyIndex = prop.selectedKeys[k];                propkeys.push({time:keyTime,value:keyValue,idx: keyIndex});             };// close K loop             props.push({property: prop, keydata: propkeys});        }; // close J loop        data.push({layer:lyr,properties: props});    }; // close I loop// alert(data[0].layer.name);// for(var l = 0; l < data.length;l++){    // alert(data[l].properties[0].property);    for(var m = 0; m < data[l].properties.length; m++){         // alert(data[l].properties[m].property.name);         for(var n = data[l].properties[m].keydata.length -1; n >= 0; n--){            // alert(data[l].properties[m].keydata[n]);                         var idx = data[l].properties[m].keydata[n].idx;             // alert(idx);             data[l].properties[m].property.removeKey(idx);         }    }}var shuffle = 0;for(var o = 0; o < data.length; o++){    if(meta.settings.shufflescope == 0){    shuffle = calc_shuffle(meta) ;    }    for(var p = 0; p < data[o].properties.length; p ++){     if(meta.settings.shufflescope == 1){    shuffle = calc_shuffle(meta);    }        for(var q = 0; q < data[o].properties[p].keydata.length; q++){            if(meta.settings.shufflescope == 2){            shuffle = calc_shuffle(meta) ;            }                        var new_time = data[o].properties[p].keydata[q].time + shuffle;                        var new_value = data[o].properties[p].keydata[q].value;            var prop = data[o].properties[p].property;            prop.setValueAtTime(new_time, new_value);        }    }}    app.endUndoGroup();        }function calc_shuffle(meta){    var shuff = 0;    var range = meta.settings.range;    if(meta.settings.keytimedir == 0){    shuff = (Math.random() * (range)) - (range);    }else if(meta.settings.keytimedir == 1){        shuff = Math.random() * range;    }else if(meta.settings.keytimedir == 2){        shuff = (Math.random() * range) * -1;    }return shuff;}}